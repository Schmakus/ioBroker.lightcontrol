"use strict";

// Conversion functions, taken from: https://github.com/Qix-/color-convert

/**
 * Konvertiert eine Farbtemperatur von Kelvin in RGB-Werte.
 * @param {number} kelvin - Die Farbtemperatur in Kelvin.
 * @returns {Promise<array>} - Das RGB-Array mit den Eigenschaften "r", "g" und "b".
 */
async function convertKelvinToRGB(kelvin) {
	let red, green, blue;

	if (kelvin <= 6600) {
		red = 255;
		green = Math.round(99.4708025861 * Math.log(kelvin) - 161.1195681661);
		if (kelvin <= 2000) {
			blue = 0;
		} else {
			blue = Math.round(138.5177312231 * Math.log(kelvin - 2000) - 305.0447927307);
		}
	} else {
		red = Math.round(329.698727446 * Math.pow((kelvin - 6600) / 1000, -0.1332047592));
		green = Math.round(288.1221695283 * Math.pow((kelvin - 6600) / 1000, -0.0755148492));
		blue = 255;
	}

	return [red, green, blue];
}

/**
 * Konvertiert einen Kelvin-Wert in einen HUE-Farbwert.
 * @async
 * @param {number} kelvin - Der Kelvin-Wert, der konvertiert werden soll.
 * @returns {Promise<{hue: number, saturation: number, brightness: number}>} - Ein Promise, das ein Objekt mit den HUE-Werten für Farbton, Sättigung und Helligkeit enthält.
 */
async function ConvertKelvinToHue(kelvin) {
	// Normalisierung des Kelvin-Werts auf einen Wertebereich von 0 bis 1
	const t = (kelvin - 2000) / (6500 - 2000);

	// Berechnung der HUE-Werte
	const hue = 1 - t; // Bei Kaltweiß ist der HUE-Wert 0
	const saturation = 1; // Maximale Sättigung
	const brightness = 1; // Maximale Helligkeit

	// Konvertierung der HUE-Werte in den HUE-Farbwert (0-65535)
	const hueValue = Math.round(hue * 65535);
	const saturationValue = Math.round(saturation * 254);
	const brightnessValue = Math.round(brightness * 254);

	return { hue: hueValue, saturation: saturationValue, brightness: brightnessValue };
}

async function ConvertHsvToRgb(hsv) {
	const h = hsv[0] / 60;
	const s = hsv[1] / 100;
	let v = hsv[2] / 100;
	const hi = Math.floor(h) % 6;

	const f = h - Math.floor(h);
	const p = 255 * v * (1 - s);
	const q = 255 * v * (1 - s * f);
	const t = 255 * v * (1 - s * (1 - f));
	v *= 255;

	switch (hi) {
		case 0:
			return [v, t, p];
		case 1:
			return [q, v, p];
		case 2:
			return [p, v, t];
		case 3:
			return [p, q, v];
		case 4:
			return [t, p, v];
		case 5:
			return [v, p, q];
	}
}

async function ConvertRgbToHsl(rgb) {
	const r = rgb[0] / 255;
	const g = rgb[1] / 255;
	const b = rgb[2] / 255;
	const min = Math.min(r, g, b);
	const max = Math.max(r, g, b);
	const delta = max - min;
	let h = 0;
	let s;

	if (max === min) {
		h = 0;
	} else if (r === max) {
		h = (g - b) / delta;
	} else if (g === max) {
		h = 2 + (b - r) / delta;
	} else if (b === max) {
		h = 4 + (r - g) / delta;
	}

	h = Math.min(h * 60, 360);

	if (h < 0) {
		h += 360;
	}

	const l = (min + max) / 2;

	if (max === min) {
		s = 0;
	} else if (l <= 0.5) {
		s = delta / (max + min);
	} else {
		s = delta / (2 - max - min);
	}

	return [h, s * 100, l * 100];
}

async function ConvertRgbToHsv(rgb) {
	let rdif;
	let gdif;
	let bdif;
	let h = 0;
	let s;

	const r = rgb[0] / 255;
	const g = rgb[1] / 255;
	const b = rgb[2] / 255;
	const v = Math.max(r, g, b);
	const diff = v - Math.min(r, g, b);
	const diffc = function (c) {
		return (v - c) / 6 / diff + 1 / 2;
	};

	if (diff === 0) {
		h = 0;
		s = 0;
	} else {
		s = diff / v;
		rdif = diffc(r);
		gdif = diffc(g);
		bdif = diffc(b);

		if (r === v) {
			h = bdif - gdif;
		} else if (g === v) {
			h = 1 / 3 + rdif - bdif;
		} else if (b === v) {
			h = 2 / 3 + gdif - rdif;
		}

		if (h < 0) {
			h += 1;
		} else if (h > 1) {
			h -= 1;
		}
	}

	return [h * 360, s * 100, v * 100];
}

async function ConvertRgbToCmyk(rgb) {
	const r = rgb[0] / 255;
	const g = rgb[1] / 255;
	const b = rgb[2] / 255;

	const k = Math.min(1 - r, 1 - g, 1 - b);
	const c = (1 - r - k) / (1 - k) || 0;
	const m = (1 - g - k) / (1 - k) || 0;
	const y = (1 - b - k) / (1 - k) || 0;

	return [c * 100, m * 100, y * 100, k * 100];
}

async function comparativeDistance(x, y) {
	/*
        See https://en.m.wikipedia.org/wiki/Euclidean_distance#Squared_Euclidean_distance
    */
	return (x[0] - y[0]) ** 2 + (x[1] - y[1]) ** 2 + (x[2] - y[2]) ** 2;
}

async function ConvertRgbToKeyword(rgb) {
	const reversed = reverseKeywords[rgb];
	if (reversed) {
		return reversed;
	}

	let currentClosestDistance = Infinity;
	let currentClosestKeyword;

	for (const keyword of Object.keys(cssKeywords)) {
		const value = cssKeywords[keyword];

		// Compute comparative distance
		const distance = comparativeDistance(rgb, value);

		// Check if its less, if so set as closest
		if ((await distance) < currentClosestDistance) {
			// @ts-ignore
			currentClosestDistance = distance;
			currentClosestKeyword = keyword;
		}
	}

	return currentClosestKeyword;
}

async function ConvertKeywordToRgb(keyword) {
	return cssKeywords[keyword];
}

async function ConvertRgbToXyz(rgb) {
	let r = rgb[0] / 255;
	let g = rgb[1] / 255;
	let b = rgb[2] / 255;

	// Assume sRGB
	r = r > 0.04045 ? ((r + 0.055) / 1.055) ** 2.4 : r / 12.92;
	g = g > 0.04045 ? ((g + 0.055) / 1.055) ** 2.4 : g / 12.92;
	b = b > 0.04045 ? ((b + 0.055) / 1.055) ** 2.4 : b / 12.92;

	const x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
	const y = r * 0.2126729 + g * 0.7151522 + b * 0.072175;
	const z = r * 0.0193339 + g * 0.119192 + b * 0.9503041;

	return [x * 100, y * 100, z * 100];
}

async function ConvertRgbToXy(rgb) {
	let r = rgb[0] / 255;
	let g = rgb[1] / 255;
	let b = rgb[2] / 255;

	// Assume sRGB
	r = r > 0.04045 ? ((r + 0.055) / 1.055) ** 2.4 : r / 12.92;
	g = g > 0.04045 ? ((g + 0.055) / 1.055) ** 2.4 : g / 12.92;
	b = b > 0.04045 ? ((b + 0.055) / 1.055) ** 2.4 : b / 12.92;

	const x = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
	const y = r * 0.2126729 + g * 0.7151522 + b * 0.072175;
	const z = r * 0.0193339 + g * 0.119192 + b * 0.9503041;

	const X = x / (x + y + z);
	const Y = y / (x + y + z);
	return [X, Y];
	//return X + "," + Y;
}

async function ConvertRgbToLab(rgb) {
	const xyz = ConvertRgbToXyz(rgb);
	let x = xyz[0];
	let y = xyz[1];
	let z = xyz[2];

	x /= 95.047;
	y /= 100;
	z /= 108.883;

	x = x > 0.008856 ? x ** (1 / 3) : 7.787 * x + 16 / 116;
	y = y > 0.008856 ? y ** (1 / 3) : 7.787 * y + 16 / 116;
	z = z > 0.008856 ? z ** (1 / 3) : 7.787 * z + 16 / 116;

	const l = 116 * y - 16;
	const a = 500 * (x - y);
	const b = 200 * (y - z);

	return [l, a, b];
}

async function ConvertRgbToHex(args) {
	const integer =
		((Math.round(args[0]) & 0xff) << 16) + ((Math.round(args[1]) & 0xff) << 8) + (Math.round(args[2]) & 0xff);

	const string = integer.toString(16).toUpperCase();
	return "000000".substring(string.length) + string;
}

/**
 * Konvertiert einen Hex-Wert in einen RGB-Farbwert.
 * @async
 * @param {string} hex - Der Hex-Wert, der konvertiert werden soll (z.B. "#FFFFFF").
 * @returns {Promise<{red: number, green: number, blue: number}>} - Ein Promise, das ein Objekt mit den RGB-Werten für Rot, Grün und Blau enthält.
 */
async function ConvertHexToRgb(hex) {
	hex = hex.replace("#", "");
	const red = parseInt(hex.substring(0, 2), 16);
	const green = parseInt(hex.substring(2, 4), 16);
	const blue = parseInt(hex.substring(4, 6), 16);

	return { red, green, blue };
}

/**
 * Konvertiert RGB-Komponenten in einen HUE-Wert.
 * @async
 * @param {number} red - Der Rotwert (0-255).
 * @param {number} green - Der Grünwert (0-255).
 * @param {number} blue - Der Blauwert (0-255).
 * @returns {Promise<number>} - Der HUE-Wert (0-65535).
 */
async function ConvertRgbToHue(red, green, blue) {
	const r = red / 255;
	const g = green / 255;
	const b = blue / 255;

	const max = Math.max(r, g, b);
	const min = Math.min(r, g, b);
	const diff = max - min;

	let hue = 0;

	if (diff === 0) {
		hue = 0;
	} else if (max === r) {
		hue = ((g - b) / diff) % 6;
	} else if (max === g) {
		hue = (b - r) / diff + 2;
	} else {
		hue = (r - g) / diff + 4;
	}

	hue = Math.round((hue * 65535) / 6);

	return hue;
}

/**
 * Konvertiert einen Hex-Wert in einen HUE-Farbwert.
 * @async
 * @param {string} hex - Der Hex-Wert, der konvertiert werden soll (z.B. "#FFFFFF").
 * @returns {Promise<{hue: number, saturation: number, brightness: number}>} - Ein Promise, das ein Objekt mit den HUE-Werten für Farbton, Sättigung und Helligkeit enthält.
 */
async function ConvertHexToHue(hex) {
	const rgb = await ConvertHexToRgb(hex);
	const hue = await ConvertRgbToHue(rgb.red, rgb.green, rgb.blue);

	return { hue, saturation: 1, brightness: 1 };
}

const cssKeywords = {
	aliceblue: [240, 248, 255],
	antiquewhite: [250, 235, 215],
	aqua: [0, 255, 255],
	aquamarine: [127, 255, 212],
	azure: [240, 255, 255],
	beige: [245, 245, 220],
	bisque: [255, 228, 196],
	black: [0, 0, 0],
	blanchedalmond: [255, 235, 205],
	blue: [0, 0, 255],
	blueviolet: [138, 43, 226],
	brown: [165, 42, 42],
	burlywood: [222, 184, 135],
	cadetblue: [95, 158, 160],
	chartreuse: [127, 255, 0],
	chocolate: [210, 105, 30],
	coral: [255, 127, 80],
	cornflowerblue: [100, 149, 237],
	cornsilk: [255, 248, 220],
	crimson: [220, 20, 60],
	cyan: [0, 255, 255],
	darkblue: [0, 0, 139],
	darkcyan: [0, 139, 139],
	darkgoldenrod: [184, 134, 11],
	darkgray: [169, 169, 169],
	darkgreen: [0, 100, 0],
	darkgrey: [169, 169, 169],
	darkkhaki: [189, 183, 107],
	darkmagenta: [139, 0, 139],
	darkolivegreen: [85, 107, 47],
	darkorange: [255, 140, 0],
	darkorchid: [153, 50, 204],
	darkred: [139, 0, 0],
	darksalmon: [233, 150, 122],
	darkseagreen: [143, 188, 143],
	darkslateblue: [72, 61, 139],
	darkslategray: [47, 79, 79],
	darkslategrey: [47, 79, 79],
	darkturquoise: [0, 206, 209],
	darkviolet: [148, 0, 211],
	deeppink: [255, 20, 147],
	deepskyblue: [0, 191, 255],
	dimgray: [105, 105, 105],
	dimgrey: [105, 105, 105],
	dodgerblue: [30, 144, 255],
	firebrick: [178, 34, 34],
	floralwhite: [255, 250, 240],
	forestgreen: [34, 139, 34],
	fuchsia: [255, 0, 255],
	gainsboro: [220, 220, 220],
	ghostwhite: [248, 248, 255],
	gold: [255, 215, 0],
	goldenrod: [218, 165, 32],
	gray: [128, 128, 128],
	green: [0, 128, 0],
	greenyellow: [173, 255, 47],
	grey: [128, 128, 128],
	honeydew: [240, 255, 240],
	hotpink: [255, 105, 180],
	indianred: [205, 92, 92],
	indigo: [75, 0, 130],
	ivory: [255, 255, 240],
	khaki: [240, 230, 140],
	lavender: [230, 230, 250],
	lavenderblush: [255, 240, 245],
	lawngreen: [124, 252, 0],
	lemonchiffon: [255, 250, 205],
	lightblue: [173, 216, 230],
	lightcoral: [240, 128, 128],
	lightcyan: [224, 255, 255],
	lightgoldenrodyellow: [250, 250, 210],
	lightgray: [211, 211, 211],
	lightgreen: [144, 238, 144],
	lightgrey: [211, 211, 211],
	lightpink: [255, 182, 193],
	lightsalmon: [255, 160, 122],
	lightseagreen: [32, 178, 170],
	lightskyblue: [135, 206, 250],
	lightslategray: [119, 136, 153],
	lightslategrey: [119, 136, 153],
	lightsteelblue: [176, 196, 222],
	lightyellow: [255, 255, 224],
	lime: [0, 255, 0],
	limegreen: [50, 205, 50],
	linen: [250, 240, 230],
	magenta: [255, 0, 255],
	maroon: [128, 0, 0],
	mediumaquamarine: [102, 205, 170],
	mediumblue: [0, 0, 205],
	mediumorchid: [186, 85, 211],
	mediumpurple: [147, 112, 219],
	mediumseagreen: [60, 179, 113],
	mediumslateblue: [123, 104, 238],
	mediumspringgreen: [0, 250, 154],
	mediumturquoise: [72, 209, 204],
	mediumvioletred: [199, 21, 133],
	midnightblue: [25, 25, 112],
	mintcream: [245, 255, 250],
	mistyrose: [255, 228, 225],
	moccasin: [255, 228, 181],
	navajowhite: [255, 222, 173],
	navy: [0, 0, 128],
	oldlace: [253, 245, 230],
	olive: [128, 128, 0],
	olivedrab: [107, 142, 35],
	orange: [255, 165, 0],
	orangered: [255, 69, 0],
	orchid: [218, 112, 214],
	palegoldenrod: [238, 232, 170],
	palegreen: [152, 251, 152],
	paleturquoise: [175, 238, 238],
	palevioletred: [219, 112, 147],
	papayawhip: [255, 239, 213],
	peachpuff: [255, 218, 185],
	peru: [205, 133, 63],
	pink: [255, 192, 203],
	plum: [221, 160, 221],
	powderblue: [176, 224, 230],
	purple: [128, 0, 128],
	rebeccapurple: [102, 51, 153],
	red: [255, 0, 0],
	rosybrown: [188, 143, 143],
	royalblue: [65, 105, 225],
	saddlebrown: [139, 69, 19],
	salmon: [250, 128, 114],
	sandybrown: [244, 164, 96],
	seagreen: [46, 139, 87],
	seashell: [255, 245, 238],
	sienna: [160, 82, 45],
	silver: [192, 192, 192],
	skyblue: [135, 206, 235],
	slateblue: [106, 90, 205],
	slategray: [112, 128, 144],
	slategrey: [112, 128, 144],
	snow: [255, 250, 250],
	springgreen: [0, 255, 127],
	steelblue: [70, 130, 180],
	tan: [210, 180, 140],
	teal: [0, 128, 128],
	thistle: [216, 191, 216],
	tomato: [255, 99, 71],
	turquoise: [64, 224, 208],
	violet: [238, 130, 238],
	wheat: [245, 222, 179],
	white: [255, 255, 255],
	whitesmoke: [245, 245, 245],
	yellow: [255, 255, 0],
	yellowgreen: [154, 205, 50],
};

// NOTE: conversions should only return primitive values (i.e. arrays, or
//       values that give correct `typeof` results).
//       do not use box values types (i.e. Number(), String(), etc.)

const reverseKeywords = {};
for (const key of Object.keys(cssKeywords)) {
	reverseKeywords[cssKeywords[key]] = key;
}

module.exports = {
	ConvertHexToRgb,
	ConvertHsvToRgb,
	ConvertKeywordToRgb,
	ConvertRgbToCmyk,
	ConvertRgbToHex,
	ConvertRgbToHsl,
	ConvertRgbToHsv,
	ConvertRgbToKeyword,
	ConvertRgbToLab,
	ConvertRgbToXy,
	ConvertRgbToXyz,
	ConvertKelvinToHue,
	ConvertHexToHue,
	convertKelvinToRGB,
};
